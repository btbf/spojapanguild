# P2Pãƒˆãƒãƒ­ã‚¸ãƒ¼è¨­å®š

!!! info "å‰ææ¡ä»¶"
    **ã“ã®é …ç›®ã¯ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ã§å®Ÿæ–½ã—ã¾ã™**  
    ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„** 
    ```sh
    journalctl --unit=cardano-node --follow
    ```

!!! info "é‡è¦ï¼šãƒˆãƒãƒ­ã‚¸ãƒ¼ã®å½¢æˆã«ã¤ã„ã¦"
    2022/01/07æ™‚ç‚¹ã§ã¯æ‰‹å‹•P2P\(ãƒ”ã‚¢ãƒ»ãƒ„ãƒ¼ãƒ»ãƒ”ã‚¢\)ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€æ‰‹å‹•ã§ãƒˆãƒãƒ­ã‚¸ãƒ¼ã‚’æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ‰‹é †ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã¨ç”Ÿæˆã—ãŸãƒ–ãƒ­ãƒƒã‚¯ãŒãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³å¤–ã§å­¤ç«‹ã™ã‚‹ãŸã‚ã€å¿…é ˆã®è¨­å®šé …ç›®ã¨ãªã‚Šã¾ã™ã€‚


## TopologyUpdaterã®è¨­å®š

| ãƒ•ã‚¡ã‚¤ãƒ«      | ç”¨é€”                          |
| :---------- | :----------------------------------- |
| `topologyUpdater.sh`       | ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆç™»éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆ  |
| `relay-topology_pull.sh`       | ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ |

ãƒŽãƒ¼ãƒ‰æƒ…å ±ã‚’ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€Œ`topologyUpdater.sh`ã€ã‚’ä½œæˆã—ã¾ã™ã€‚

!!! hint "topologyUpdater.shã«ã¤ã„ã¦"
    ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰æƒ…å ±(IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã€ã‚ªãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹)ã‚’ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆã¸1æ™‚é–“ã«1å›žé€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ä¸–ç•Œä¸­ã®ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ã«è‡ªãƒ—ãƒ¼ãƒ«ã®ãƒªãƒ¬ãƒ¼æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã‚‹ä»•çµ„ã¿ã§ã™


  
### ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ 
  
!!! warning "æ³¨æ„"
    ä»¥ä¸‹ã¯ã€ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¨ãƒŽãƒ¼ãƒ‰ãƒãƒ¼ãƒˆã«åˆã‚ã›ã‚‹  
    CNODE_PORT=6000  
    CNODE_HOSTNAME="xxx.xxx.xxx.xx"  
    â€»26è¡Œç›®ã®"CHANGE ME"ã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„
    
=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"
    ```bash
    cat > $NODE_HOME/topologyUpdater.sh << EOF
    #!/bin/bash
    # shellcheck disable=SC2086,SC2034
    
    USERNAME=$(whoami)
    CNODE_PORT=6000
    CNODE_HOSTNAME="xxx.xxx.xxx.xx"
    CNODE_BIN="/usr/local/bin"
    CNODE_HOME=$NODE_HOME
    CNODE_LOG_DIR="\${CNODE_HOME}/logs"
    GENESIS_JSON="\${CNODE_HOME}/${NODE_CONFIG}-shelley-genesis.json"
    NETWORKID=\$(jq -r .networkId \$GENESIS_JSON)
    CNODE_VALENCY=1   # optional for multi-IP hostnames
    NWMAGIC=\$(jq -r .networkMagic < \$GENESIS_JSON)
    [[ "\${NETWORKID}" = "Mainnet" ]] && HASH_IDENTIFIER="--mainnet" || HASH_IDENTIFIER="--testnet-magic \${NWMAGIC}"
    [[ "\${NWMAGIC}" = "764824073" ]] && NETWORK_IDENTIFIER="--mainnet" || NETWORK_IDENTIFIER="--testnet-magic \${NWMAGIC}"
    
    export PATH="\${CNODE_BIN}:\${PATH}"
    export CARDANO_NODE_SOCKET_PATH="\${CNODE_HOME}/db/socket"
    
    blockNo=\$(/usr/local/bin/cardano-cli query tip \${NETWORK_IDENTIFIER} | jq -r .block )
    
    # Note:
    # if you run your node in IPv4/IPv6 dual stack network configuration and want announced the
    # IPv4 address only please add the -4 parameter to the curl command below  (curl -4 -s ...)
    if [ "\${CNODE_HOSTNAME}" != "CHANGE ME" ]; then
    T_HOSTNAME="&hostname=\${CNODE_HOSTNAME}"
    else
    T_HOSTNAME=''
    fi

    if [ ! -d \${CNODE_LOG_DIR} ]; then
    mkdir -p \${CNODE_LOG_DIR};
    fi
    
    curl -4 -s "https://api.clio.one/htopology/v1/?port=\${CNODE_PORT}&blockNo=\${blockNo}&valency=\${CNODE_VALENCY}&magic=\${NWMAGIC}\${T_HOSTNAME}" | tee -a \$CNODE_LOG_DIR/topologyUpdater_lastresult.json
    EOF
    ```

æ¨©é™ã‚’è¿½åŠ ã—ã€ã€ŒtopologyUpdater.shã€ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"
    ```bash
    cd $NODE_HOME
    chmod +x topologyUpdater.sh
    ./topologyUpdater.sh
    ```

`topologyUpdater.sh`ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã€ä»¥ä¸‹ã®å½¢å¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

> `{ "resultcode": "201", "datetime":"2020-07-28 01:23:45", "clientIp": "1.2.3.4", "iptype": 4, "msg": "nice to meet you" }`

!!! fail "æ³¨æ„"
    â€»`topologyUpdater.sh`ã¯1æ™‚é–“ä»¥å†…ã«2å›žä»¥ä¸Šå®Ÿè¡Œã—ãªã„ã§ä¸‹ã•ã„ã€‚æœ€æ‚ªã®å ´åˆãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«ã€**`$NODE_HOME/logs`**ã«ãƒ­ã‚°ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ 


### Cronã‚¸ãƒ§ãƒ–ã®è¨­å®š

crontabã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã€ã€ŒtopologyUpdater.shã€ã‚’1æ™‚é–“ã«1å›žè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
    

!!! danger "æ³¨æ„"
    * ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯è¤‡æ•°å›žå®Ÿè¡Œã—ãªã„ã§ä¸‹ã•ã„ã€‚è¤‡æ•°å›žå®Ÿè¡Œã—ãŸå ´åˆã€åŒã˜æ™‚é–“ã«è¤‡æ•°è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å…¥ã‚Šã¾ã™ã€‚
    * ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯æ¯Žæ™‚22åˆ†ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚\(ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ãŸæ™‚é–“\(åˆ†\)ã‚’æŒ‡å®šã—ã¦ä¸‹ã•ã„\)

=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"
    ```bash
    cat > $NODE_HOME/crontab-fragment.txt << EOF
    22 * * * * ${NODE_HOME}/topologyUpdater.sh
    EOF
    crontab -l | cat - crontab-fragment.txt >crontab.txt && crontab crontab.txt
    rm crontab-fragment.txt
    ```

    > no crontab for ~~
    ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€Cronåˆå›žè¨­å®šæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãªã‚Šã¾ã™ã®ã§ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

    ```
    crontab -l
    ```
    ä»¥ä¸‹ãŒè¿”ã‚Šå€¤ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚Œã°OKã€‚
    > "22 * * * * /home/***/cnode/topologyUpdater.sh"


    !!! success "ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆã¸ã®ç™»éŒ²ã«ã¤ã„ã¦"
        4æ™‚é–“ã®é–“ã§4å›žã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã«ã€ãƒŽãƒ¼ãƒ‰ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§æœ‰ã‚‹ã“ã¨ãŒèªã‚ã‚‰ã‚ŒãŸå ´åˆã«ãƒŽãƒ¼ãƒ‰IPãŒãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚ä¸Šè¨˜è¨­å®šã‹ã‚‰4æ™‚é–“å¾Œã«æ¬¡ã®é …ç›®ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚



### ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆç™»éŒ²ç¢ºèª
=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"

    ```bash
    cd $NODE_HOME/logs
    cat topologyUpdater_lastresult.json
    ```

ä»¥ä¸‹ã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ç™»éŒ²æˆåŠŸ  
resultcodeãŒ400ç•ªå°ãƒ»500ç•ªå°ã®å ´åˆã¯ã€ã‚µãƒ¼ãƒè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
```
{ "resultcode": "201", "datetime":"2021-01-10 18:30:06", "clientIp": "000.000.000.000", "iptype": 4, "msg": "nice to meet you" }
{ "resultcode": "203", "datetime":"2021-01-10 19:30:03", "clientIp": "000.000.000.000", "iptype": 4, "msg": "welcome to the topology" }
{ "resultcode": "204", "datetime":"2021-01-10 20:30:04", "clientIp": "000.000.000.000", "iptype": 4, "msg": "glad you're staying with us" }
```


### ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹

!!! hint "å‰ææ¡ä»¶"
    ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰IPãŒãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚§ãƒƒãƒãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªå¾Œã€ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ä¸‹ã•ã„ã€‚

??? hint "ãƒˆãƒãƒ­ã‚¸ãƒ¼ã®å½¢æˆæ–¹æ³•â–¼"
    ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹`relay-topology_pull.sh`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ 
    ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆãƒ»å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ä¸–ç•Œä¸­ã®ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰æƒ…å ±ã®ä¸­ã‹ã‚‰è‡ªåˆ†ã®ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ã«å¯¾ã—ã¦è¿‘è·é›¢ãƒ»ä¸­è·é›¢ãƒ»é è·é›¢ã«åˆ†æ•£ã—ãŸãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—åŠè‡ªå‹•ã§ãƒˆãƒãƒ­ã‚¸ãƒ¼ã‚’å½¢æˆã§ãã¾ã™ã€‚ 
  
??? hint  "å€‹åˆ¥ã«è¿½åŠ ã—ãŸã„å ´åˆâ–¼"
    â€»ãŠçŸ¥ã‚Šåˆã„ã®ãƒŽãƒ¼ãƒ‰ã‚„è‡ªãƒŽãƒ¼ãƒ‰ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã€IOHKãƒŽãƒ¼ãƒ‰æƒ…å ±ã®å¾Œã« "|" ã§åŒºåˆ‡ã£ã¦`IPã‚¢ãƒ‰ãƒ¬ã‚¹`:`ãƒãƒ¼ãƒˆç•ªå·`:`Valency` ã®å½¢å¼ã§è¿½åŠ ã§ãã¾ã™ã€‚  
    ```
    |relays-new.cardano-mainnet.iohk.io:3001:2|relay1-eu.xstakepool.com:3001:1|00.000.000.00:3001:1
    ```

!!! warning "æ³¨æ„"
    ä»¥ä¸‹ã¯ã€BPã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¨ãƒŽãƒ¼ãƒ‰ãƒãƒ¼ãƒˆã«æ›¸ãæ›ãˆã¦ã‹ã‚‰ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹  
    BLOCKPRODUCING_IP=\*\*\*.\*\*\*.\*\*\*  
    BLOCKPRODUCING_PORT=6000 

=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"
    ```bash
    cat > $NODE_HOME/relay-topology_pull.sh << EOF
    #!/bin/bash
    BLOCKPRODUCING_IP=***.***.***
    BLOCKPRODUCING_PORT=6000
    PEERS=18
    curl -4 -s -o $NODE_HOME/${NODE_CONFIG}-topology.json "https://api.clio.one/htopology/v1/fetch/?max=\${PEERS}&customPeers=\${BLOCKPRODUCING_IP}:\${BLOCKPRODUCING_PORT}:1|relays-new.cardano-mainnet.iohk.io:3001:2"
    EOF
    ```

shãƒ•ã‚¡ã‚¤ãƒ«ã«æ¨©é™ã‚’è¿½åŠ ã—ã€relay-topology_pull.shã‚’å®Ÿè¡Œã™ã‚‹

=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"
    ```bash
    cd $NODE_HOME
    chmod +x relay-topology_pull.sh
    ./relay-topology_pull.sh
    ```

!!! hint ""
    relay-topology_pull.shã‚’å®Ÿè¡Œã™ã‚‹ã¨æ–°ã—ã„ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«\(mainnet-topology.json\)ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

!!! warning ""
    ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ãŸå ´åˆã¯ã€ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰ã‚’å†èµ·å‹•ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ä¸‹ã•ã„ã€‚

=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰"
    ```bash
    sudo systemctl reload-or-restart cardano-node
    ```


!!! danger "ðŸ”¥é‡è¦ãªç¢ºèªäº‹é …ðŸ”¥"
    ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€ã€ŒTotal Txã€ãŒå¢—åŠ ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸‡ä¸€ã€å¢—åŠ ã—ã¦ã„ãªã„å ´åˆã«ã¯ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚„ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å†ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚ã€ŒP2Pã€æ•°ã¯ãƒŽãƒ¼ãƒ‰ãŒä»–ãƒŽãƒ¼ãƒ‰ã¨æŽ¥ç¶šã—ã¦ã„ã‚‹æ•°ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚


**ðŸ›  ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰/BPã§gLiveView ã‚’ç¢ºèª**

=== "ãƒªãƒ¬ãƒ¼ãƒŽãƒ¼ãƒ‰/BP"
```bash
cd $NODE_HOME/scripts
./gLiveView.sh
```

!!! info ""
    ã€ŒTotal Txã€ãŒå¢—åŠ ã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹


!!! success "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼"
    Total TxãŒå¢—åŠ ãŒç¢ºèªã§ãã‚Œã°ã€ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹æº–å‚™ãŒå‡ºæ¥ã¾ã—ãŸã€‚

